![Ejemplo de plantilla de marketing](assets/laravel-whatsapp-manager.png "Plantilla de Marketing")


# üì± WhatsApp Business API Manager for Laravel

LARAVEL WHatsapp Manager

**Un paquete elegante y potente para integrar WhatsApp Business API en tus aplicaciones Laravel 12+.**  
‚ú® Gesti√≥n de mensajes, plantillas, campa√±as, flujos conversacionales, m√©tricas y m√°s.

# Este paquete esta en version ALPHA.
## Las migraciones y codigo estan en constante cambio hasta lograr la Version Estable

---

## üöÄ Caracter√≠sticas Principales

- **Env√≠a mensajes** de texto, multimedia, interactivos y de plantilla.
- **Gestion de Templates** para Crear, Listar, Eliminar y Probar plantillas.
- **Webhooks integrados** para recibir mensajes y actualizaciones.
- **Gesti√≥n de conversaciones** con m√©tricas de cobro. üí∞
- **Bots conversacionales** con flujos din√°micos. ü§ñ
- **Sincronizaci√≥n autom√°tica** de n√∫meros telef√≥nicos y perfiles.
- **Soporte para campa√±as** masivas programadas. üìÖ
- 100% compatible con **Laravel Echo y Reverb** para notificaciones en tiempo real.

---

---

## üöÄ Instalaci√≥n

1. **Instala el paquete v√≠a Composer**:
   ```bash
   composer require scriptdevelop/whatsapp-manager
   ```

2. **Publica la configuraci√≥n (opcional)**:
   ```bash
   php artisan vendor:publish --tag=whatsapp-config
   ```

   ‚öôÔ∏è Configuraci√≥n

   Configuraci√≥n principal (config/whatsapp.php):
      
   Configuraci√≥n de logs (config/logging.php):

   Configuraci√≥n principal del paquete:
   A√±adir el canal whatsapp.

      ```php
      'channels' => [
         'whatsapp' => [
               'driver' => 'daily',
               'path' => storage_path('logs/whatsapp.log'),
               'level' => 'debug',
               'days' => 7,
               'tap' => [\ScriptDevelop\WhatsappManager\Logging\CustomizeFormatter::class],
         ],
      ],
      ```

3. **Publica las migraciones (opcional)**:
   ```bash
   php artisan vendor:publish --tag=whatsapp-migrations

4. **Publica las rutas (OBLIGATORIO)**:
   Se necesita para el webhook.

   ```bash
   php artisan vendor:publish --tag=whatsapp-routes
   ```

   Excluir rutas del webhook de CSRF:

   Al publicar las rutas es importante anexar las rutas del webhook a las excepciones del CSRF.
   En bootstrap/app.php:

   ```php
   ->withMiddleware(function (Middleware $middleware) {
        $middleware->validateCsrfTokens(except: [
            '/whatsapp-webhook',
        ]);
    })
   ```

5. **Configura tus credenciales en .env**:
   ```bash
   WHATSAPP_API_URL=https://graph.facebook.com
   WHATSAPP_API_VERSION=v21.0
   WHATSAPP_VERIFY_TOKEN=your-verify-token
   WHATSAPP_USER_MODEL=App\Models\User


üîÑ Personalizar el Modelo User

Si usas un modelo User personalizado:

   Si est√°s utilizando un modelo User personalizado, aseg√∫rate de especificarlo en tu archivo `.env`:

   ```bash
   WHATSAPP_USER_MODEL=App\Models\YourCustomUserModel
   ```

Adem√°s, verifica que el modelo implementa las interfaces necesarias o extiende el modelo base esperado por el paquete. Por ejemplo:

```php
namespace App\Modules\Auth\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;

class Admin extends Authenticatable
{
   // Tu l√≥gica personalizada aqu√≠
}
```


6.  üóÉÔ∏è Migraciones

üîç Verificar configuraci√≥n del User Model

**Verifica el modelo de usuario configurado**:

Ejecuta el siguiente comando para asegurarte de que el modelo de usuario est√° correctamente configurado:

```bash
php artisan whatsapp:check-user-model
```

Este comando validar√° que el modelo especificado en el archivo `.env` cumple con los requisitos del paquete.

Salida esperada (ejemplo):
```plaintext
‚úÖ Modelo User configurado: App\Models\User
```

Si hay alg√∫n problema, revisa la configuraci√≥n en tu archivo `.env` y aseg√∫rate de que el modelo implementa las interfaces necesarias.


Ejecuta las migraciones para crear las tablas necesarias:
   
```bash
php artisan migrate
```

Esto ejecutar√° las migraciones necesarias para crear las tablas requeridas por el paquete en tu base de datos.

Tablas incluidas:

- whatsapp_business_accounts üìá  
- whatsapp_phone_numbers ‚òéÔ∏è  
- campaigns üì¢  
- chat_sessions üí¨  
- message_templates üìù  
- messages üì©  
- message_logs üìú  
- contacts üìã  
- contact_groups üë•  
- group_contacts üîó  
- scheduled_messages ‚è∞  
- message_attachments üìé  
- api_tokens üîë  
- webhook_events üåê  
- conversation_flows üîÑ  
- flow_steps üõ†Ô∏è  
- flow_conditions ‚öôÔ∏è  


Este comando publicar√° las migraciones del paquete en tu directorio `database/migrations`. Puedes personalizarlas seg√∫n tus necesidades antes de ejecutarlas.

üì° Configuraci√≥n de Webhooks en Meta
Ir a Meta Developers

Configurar Webhook:
- Define la URL del webhook en la consola de Meta Developers.
- La URL debe apuntar a la ruta publicada por el paquete, por ejemplo

URL: https://tudominio.com/whatsapp-webhook

Token: EL_TOKEN_DE_TU_.ENV

Eventos a suscribir: messages, message_statuses

Tambien puedes usar la herramienta nrock
üß© Estructura del Paquete

```bash
whatsapp-manager/
‚îú‚îÄ‚îÄ .env.testing              # Archivo de configuraci√≥n para pruebas
‚îú‚îÄ‚îÄ composer.json             # Configuraci√≥n de dependencias del paquete
‚îú‚îÄ‚îÄ composer.lock             # Archivo de bloqueo de dependencias
‚îú‚îÄ‚îÄ LICENSE                   # Licencia del paquete
‚îú‚îÄ‚îÄ phpunit.xml               # Configuraci√≥n de PHPUnit para pruebas
‚îú‚îÄ‚îÄ README.md                 # Documentaci√≥n principal del paquete
‚îú‚îÄ‚îÄ .vscode/
‚îÇ   ‚îî‚îÄ‚îÄ settings.json         # Configuraci√≥n espec√≠fica para Visual Studio Code
‚îú‚îÄ‚îÄ assets/                   # Archivos de recursos
‚îÇ   ‚îú‚îÄ‚îÄ 2394384167581644.ogg  # Archivo de audio de ejemplo
‚îÇ   ‚îú‚îÄ‚îÄ LARAVEL WHATSAPP MANEGER.pdf # Documento PDF de ejemplo
‚îÇ   ‚îî‚îÄ‚îÄ laravel-whatsapp-manager.png # Imagen de ejemplo
‚îú‚îÄ‚îÄ src/                      # C√≥digo fuente principal del paquete
‚îÇ   ‚îú‚îÄ‚îÄ Config/               # Archivos de configuraci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logging.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ whatsapp.php
‚îÇ   ‚îú‚îÄ‚îÄ Console/              # Comandos Artisan personalizados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CheckUserModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MergeLoggingConfig.php
‚îÇ   ‚îú‚îÄ‚îÄ Database/             # Migraciones y seeders
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Migrations/       # Migraciones de base de datos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Seeders/          # Seeders opcionales
‚îÇ   ‚îú‚îÄ‚îÄ Enums/                # Enumeraciones del sistema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageStatus.php
‚îÇ   ‚îú‚îÄ‚îÄ Exceptions/           # Excepciones personalizadas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InvalidApiResponseException.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhatsappApiException.php
‚îÇ   ‚îú‚îÄ‚îÄ Facades/              # Facades del paquete
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ whatsapp.php
‚îÇ   ‚îú‚îÄ‚îÄ Helpers/              # Funciones y utilidades auxiliares   
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CountryCodes.php
‚îÇ   ‚îú‚îÄ‚îÄ Http/                 # L√≥gica HTTP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/      # Controladores HTTP y Webhook
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhatsappWebhookController.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Middleware/       # Middleware personalizados
‚îÇ   ‚îú‚îÄ‚îÄ Logging/              # Personalizaci√≥n de logs  
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CustomizeFormatter.php
‚îÇ   ‚îú‚îÄ‚îÄ Models/               # Modelos Eloquent
‚îÇ   ‚îú‚îÄ‚îÄ Providers/            # Proveedores de servicios del paquete  
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhatsappServiceProvider.php
‚îÇ   ‚îú‚îÄ‚îÄ Repositories/         # Repositorios para acceso a datos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhatsappBusinessAccountRepository.php
‚îÇ   ‚îú‚îÄ‚îÄ routes/               # Rutas del paquete
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ whatsapp_webhook.php
‚îÇ   ‚îú‚îÄ‚îÄ Services/             # L√≥gica de negocio y API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AccountRegistrationService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageDispatcherService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TemplateBuilder.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TemplateMessageBuilder.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TemplateService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhatsappManager.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhatsappService.php
‚îÇ   ‚îú‚îÄ‚îÄ Traits/               # Traits reutilizables
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GeneratesUlid.php
‚îÇ   ‚îî‚îÄ‚îÄ WhatsappApi/          # Cliente API y endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DataTransferObjects/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ApiErrorResponse.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BusinessAccountResponse.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageResponse.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Exceptions/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BusinessProfileValidator.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ApiClient.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Endpoints.php     
‚îú‚îÄ‚îÄ tests/                    # Pruebas del paquete
‚îÇ   ‚îú‚îÄ‚îÄ TestCase.php          # Clase base para pruebas
‚îÇ   ‚îú‚îÄ‚îÄ Feature/              # Pruebas funcionales
‚îÇ   ‚îî‚îÄ‚îÄ Unit/                 # Pruebas unitarias
‚îî‚îÄ‚îÄ vendor/                   # Dependencias instaladas por Composer
```


üìñ Gu√≠a de Usuario

## 1. Registro de Cuentas de Negocios
Registra una cuenta de negocios en WhatsApp Business API.
Se hace la peticion a la API de whatsapp, se obtienen los datos de la cuenta y se almacenan en la base de datos. Este metodo obtiene los datos de la cuenta, los telefonos de whatsapp asociados a la cuenta y el perfil de cada numero de telefono.
- Se usa para Obtener los datos desde la API y alojarlos en la base de datos.

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;

$account = Whatsapp::account()->register([
   'api_token' => '***********************',
   'business_id' => '1243432234423'
]);
```


## 2. Obtener Detalles de N√∫meros de Tel√©fono
Obt√©n informaci√≥n detallada sobre un n√∫mero de tel√©fono registrado.
Se hace la peticion a la API de whatsapp para obtener detalles del numero de whatsapp y se almacenan en la base de datos, si el numero ya existe actualiza la informacion.

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;

$phoneDetails = Whatsapp::phone()->getPhoneNumberDetails('564565346546');
```


## 3. Obtener Cuentas de Negocios
Obt√©n informaci√≥n sobre una cuenta de negocios espec√≠fica.
Se hace la peticion a la API de whatsapp para obtener informacion sobre una cuenta en especifico, se almacenan los datos en la base de datos.

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;

$account = Whatsapp::phone()->getBusinessAccount('356456456456');
```


## 4. Enviar Mensajes de Texto
Env√≠a mensajes de texto simples.

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;

$message = Whatsapp::message()->sendTextMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93', // ID del n√∫mero de tel√©fono
    '57',                        // C√≥digo de pa√≠s
    '3237121901',                // N√∫mero de tel√©fono
    'Hola, este es un mensaje de prueba.' // Contenido del mensaje
);
```


Enviar Mensajes de Texto con Enlaces
Env√≠a mensajes de texto simples.

```php
$message = Whatsapp::message()->sendTextMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    'Vis√≠tanos en YouTube: http://youtube.com',
    true // Habilitar vista previa de enlaces
);
```

## Marcar mensaje como leido
Se encarga de marcar el mensaje recibido como leido, con los dos checks azules.

```php
$message = Whatsapp::message()->markMessageAsRead('01JW939646VBZTS7JEJN21FGVE');
```

## 5. Enviar Respuestas a Mensajes
Responde a un mensaje existente.

```php
$message = Whatsapp::message()->sendReplyTextMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    'wamid.HBgMNTczMTM3MTgxOTA4FQIAEhggNzVCNUQzRDMxRjhEMUJEM0JERjAzNkZCNDk5RDcyQjQA', // ID del mensaje de contexto
    'Esta es una respuesta al mensaje anterior.'
);
```



## 6. Reacciones a Mensajes
Env√≠a una reacci√≥n a un mensaje existente.

### Sintaxis Unicode requerida - Usa la codificaci√≥n \u{c√≥digo_hex} para emojis:

```php
// Reacci√≥n con coraz√≥n rojo ‚ù§Ô∏è
$message = Whatsapp::message()->sendReplyReactionMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    'wamid.HBgMNTczMTM3MTgxOTA4FQIAEhggNzZENDMzMEI0MDRFQzg0OUUwRTI1M0JBQjEzMUZFRUYA', // ID del mensaje de contexto
    "\u{2764}\u{FE0F}" // Emoji de reacci√≥n
);


"\u{1F44D}" // üëç (Me gusta)
"\u{1F44E}" // üëé (No me gusta)
"\u{1F525}" // üî• 
"\u{1F60D}" // üòç
"\u{1F622}" // üò¢
"\u{1F389}" // üéâ
"\u{1F680}" // üöÄ
"\u{2705}" // ‚úÖ
"\u{274C}" // ‚ùå
```



## 7. Enviar Mensajes Multimedia
### Enviar Im√°genes

```php
$filePath = storage_path('app/public/laravel-whatsapp-manager.png');
$file = new \SplFileInfo($filePath);

$message = Whatsapp::message()->sendImageMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    $file
);
```

### Enviar Im√°genes por URL

```php
$message = Whatsapp::message()->sendImageMessageByUrl(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    'https://example.com/image.png'
);
```

### Enviar Audio

```php
$filePath = storage_path('app/public/audio.ogg');
$file = new \SplFileInfo($filePath);

$message = Whatsapp::message()->sendAudioMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    $file
);
```

### Enviar Audio por URL

```php
$message = Whatsapp::message()->sendAudioMessageByUrl(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    'https://example.com/audio.ogg'
);
```

### Enviar Documentos

```php
$filePath = storage_path('app/public/document.pdf');
$file = new \SplFileInfo($filePath);

$message = Whatsapp::message()->sendDocumentMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    $file
);
```

### Enviar Documentos por URL

```php
$message = Whatsapp::message()->sendDocumentMessageByUrl(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    'https://example.com/document.pdf'
);
```

## 8. Enviar Mensajes de Ubicaci√≥n
### Env√≠a un mensaje con coordenadas de ubicaci√≥n.

```php
$message = Whatsapp::message()->sendLocationMessage(
    '01JTKF55PCNNWTNEKCGMJAZV93',
    '57',
    '3237121901',
    4.7110, // Latitud
    -74.0721, // Longitud
    'Bogot√°', // Nombre del lugar
    'Colombia' // Direcci√≥n
);

$message = Whatsapp::message()->sendLocationMessage(
    phoneNumberId: $phone->phone_number_id,
    countryCode: '57',
    phoneNumber: '3137183308',
    latitude: 19.4326077,  // Latitud
    longitude: -99.133208, // Longitud
    name: 'Ciudad de M√©xico',
    address: 'Plaza de la Constituci√≥n'
);
```

## 9. Mensajes con Botones Interactivos

```php
$message = Whatsapp::message()->sendInteractiveButtonsMessage(
    phoneNumberId: $phone->phone_number_id,
    countryCode: '57',
    phoneNumber: '3136133508',
    body: 'Selecciona una opci√≥n:',
    buttons: [
        ['id' => 'op1', 'title' => 'Opci√≥n 1'], // M√°ximo 3 botones
        ['id' => 'op2', 'title' => 'Opci√≥n 2']
    ],
    footer: 'Footer opcional' // Texto secundario
);
```

## 10. Listas Desplegables Interactivas

```php
$message = Whatsapp::message()->sendListMessage(
    phoneNumberId: $phone->phone_number_id,
    countryCode: '57',
    phoneNumber: '3137555558',
    buttonText: 'Ver opciones', // M√°ximo 20 caracteres
    sections: [
        [
            'title' => 'Secci√≥n 1', // Encabezado de secci√≥n
            'rows' => [
                ['id' => 'row1', 'title' => 'Fila 1'], // Hasta 10 filas
                ['id' => 'row2', 'title' => 'Fila 2']
            ]
        ]
    ],
    body: 'Selecciona de la lista:' // Texto principal
);
```


## 11. Obtener todas las plantillas de una cuenta de whatsapp
Se obtienen todas las plantillas de una cuenta de whatsapp y se almacenan en la base de datos.
Se hace la peticion a la API de whatsapp para obtener todas las plantillas que estan asociadas a la cuenta de whatsapp.

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

// Obtener una instancia de WhatsApp Business Account
$account = WhatsappBusinessAccount::find($accountId);

// Obtener todas las plantillas de la cuenta
Whatsapp::template()->getTemplates($account);
```

- ### Obtener una plantilla por el nombre.
  Se hace la peticion a la API de whatsapp para obtener una plantilla por el nombre y se almacena en la base de datos.

   ```php
   use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
   use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

   // Obtener una instancia de WhatsApp Business Account
   $account = WhatsappBusinessAccount::find($accountId);

   // Obtener plantilla por su nombre
   $template = Whatsapp::template()->getTemplateByName($account, 'order_confirmation');
   ```


- ### Obtener una plantilla por el ID.
  Se hace la peticion a la API de whatsapp para obtener una plantilla por el ID y se almacena en la base de datos.

   ```php
   use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
   use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

   // Obtener una instancia de WhatsApp Business Account
   $account = WhatsappBusinessAccount::find($accountId);

   // Obtener plantilla por su ID
   $template = Whatsapp::template()->getTemplateById($account, '559947779843204');
   ```

- ### Eliminar plantilla de la API y de la base de datos al mismo tiempo.
  Se hace la peticion a la API de whatsapp para obtener una plantilla por el ID y se elimina la plantilla seleccionada, Existen dos maneras de eliminar Soft Delete y Hard Delete.

   ```php
   use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
   use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

   // Obtener una instancia de WhatsApp Business Account
   $account = WhatsappBusinessAccount::find($accountId);

   // Soft delete
   // Eliminar plantilla por su ID
   $template = Whatsapp::template()->gdeleteTemplateById($account, $templateId);

   // Eliminar plantilla por su Nombre
   $template = Whatsapp::template()->deleteTemplateByName($account, 'order_confirmation');


   // Hard delete
   // Eliminar plantilla por su ID
   $template = Whatsapp::template()->gdeleteTemplateById($account, $templateId, true);

   // Eliminar plantilla por su Nombre
   $template = Whatsapp::template()->deleteTemplateByName($account, 'order_confirmation', true);
   ```




- ### Editar plantilla de la API y de la base de datos al mismo tiempo.
  Se hace la peticion a la API de whatsapp para editar la plantilla seleccionada.

    ```php
    use ScriptDevelop\WhatsappManager\Models\Template;
    use ScriptDevelop\WhatsappManager\Exceptions\TemplateComponentException;
    use ScriptDevelop\WhatsappManager\Exceptions\TemplateUpdateException;

    $template = Template::find('template-id');

    try {
        $updatedTemplate = $template->edit()
            ->setName('nuevo-nombre-plantilla')
            ->changeBody('Nuevo contenido del cuerpo {{1}}', [['Ejemplo nuevo']])
            ->removeHeader()
            ->addFooter('Nuevo texto de pie de p√°gina')
            ->removeAllButtons()
            ->addButton('URL', 'Visitar sitio', 'https://ejemplo.com')
            ->addButton('QUICK_REPLY', 'Confirmar')
            ->update();
        
        return response()->json($updatedTemplate);
        
    } catch (TemplateComponentException $e) {
        // Manejar error de componente
        return response()->json(['error' => $e->getMessage()], 400);
        
    } catch (TemplateUpdateException $e) {
        // Manejar error de actualizaci√≥n
        return response()->json(['error' => $e->getMessage()], 500);
    }
    ```

    Agregar componentes a plantillas que no lo tenian:

    ```php
    $template->edit()
        ->addHeader('TEXT', 'Encabezado agregado')
        ->addFooter('Pie de p√°gina nuevo')
        ->addButton('PHONE_NUMBER', 'Llamar', '+1234567890')
        ->update();
    ```

    Eliminar componentes existentes:
    
    ```php
    $template->edit()
        ->removeFooter()
        ->removeAllButtons()
        ->update();
    ```

    Trabajar con componentes espec√≠ficos:
    
    ```php
    $editor = $template->edit();

    // Verificar y modificar header
    if ($editor->hasHeader()) {
        $headerData = $editor->getHeader();
        if ($headerData['format'] === 'TEXT') {
            $editor->changeHeader('TEXT', 'Encabezado actualizado');
        }
    } else {
        $editor->addHeader('TEXT', 'Nuevo encabezado');
    }

    // Modificar botones
    $buttons = $editor->getButtons();
    foreach ($buttons as $index => $button) {
        if ($button['type'] === 'URL' && str_contains($button['url'], 'old-domain.com')) {
            $newUrl = str_replace('old-domain.com', 'new-domain.com', $button['url']);
            $editor->removeButtonAt($index);
            $editor->addButton('URL', $button['text'], $newUrl);
        }
    }

    $editor->update();
    ```

## Caracter√≠sticas Clave del Edit Template

    1.- Gesti√≥n completa de componentes:
        - M√©todos add, change, remove para cada tipo de componente
        - M√©todos has para verificar existencia
        - M√©todos get para obtener datos

    2.- Validaciones robustas:
        - Unicidad de componentes (solo un HEADER, BODY, etc.)
        - Componentes obligatorios (BODY siempre requerido)
        - L√≠mites de botones (m√°ximo 10)
        - Restricciones de modificaci√≥n (no cambiar categor√≠a, no modificar aprobadas)

    3.- Operaciones at√≥micas:
        - removeButtonAt: Elimina un bot√≥n espec√≠fico
        - removeAllButtons: Elimina todos los botones
        - getButtons: Obtiene todos los botones actuales

    4.- Manejo de errores:
        - Excepciones espec√≠ficas para problemas de componentes
        - Excepciones para fallos en la actualizaci√≥n
        - Mensajes de error claros y descriptivos

    5.- Flujo intuitivo:
        - $template->edit() inicia la edici√≥n
        - Encadenamiento de m√©todos para modificaciones
        - update() aplica los cambios

## 12. Crear las plantillas en una cuenta de whatsapp
### Crear Plantillas de Utilidad

Las plantillas transaccionales son ideales para notificaciones como confirmaciones de pedidos, actualizaciones de env√≠o, etc.

![Ejemplo de plantilla de marketing](assets/template_1.png "Plantilla de Marketing")

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

// Obtener la cuenta empresarial
$account = WhatsappBusinessAccount::first();

// Crear una plantilla transaccional
$template = Whatsapp::template()
    ->createUtilityTemplate($account)
    ->setName('order_confirmation_3')
    ->setLanguage('en_US')
    ->addHeader('TEXT', 'Order Confirmation')
    ->addBody('Your order {{1}} has been confirmed.', ['12345'])
    ->addFooter('Thank you for shopping with us!')
    ->addButton('QUICK_REPLY', 'Track Order')
    ->addButton('QUICK_REPLY', 'Contact Support')
    ->save();
```



---

### Crear Plantillas de Marketing

Las plantillas de marketing son √∫tiles para promociones, descuentos y campa√±as masivas.

![Ejemplo de plantilla de marketing](assets/template_2.png "Plantilla de Marketing")

```php
    use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
    use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

    // Obtener la cuenta empresarial
    $account = WhatsappBusinessAccount::first();

    // Crear una plantilla de marketing con texto
    $template = Whatsapp::template()
        ->createMarketingTemplate($account)
        ->setName('personal_promotion_text_only')
        ->setLanguage('en')
        ->addHeader('TEXT', 'Our {{1}} is on!', ['Summer Sale'])
        ->addBody(
            'Shop now through {{1}} and use code {{2}} to get {{3}} off of all merchandise.',
            ['the end of August', '25OFF', '25%']
        )
        ->addFooter('Use the buttons below to manage your marketing subscriptions')
        ->addButton('QUICK_REPLY', 'Unsubscribe from Promos')
        ->addButton('QUICK_REPLY', 'Unsubscribe from All')
        ->save();
```

---

### Crear Plantillas de Marketing con Im√°genes

Las plantillas de marketing tambi√©n pueden incluir im√°genes en el encabezado para hacerlas m√°s atractivas.

![Ejemplo de plantilla de marketing](assets/template_3.png "Plantilla de Marketing")

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

// Obtener la cuenta empresarial
$account = WhatsappBusinessAccount::first();

// Ruta de la imagen
$imagePath = storage_path('app/public/laravel-whatsapp-manager.png');

// Crear una plantilla de marketing con imagen
$template = Whatsapp::template()
    ->createMarketingTemplate($account)
    ->setName('image_template_test')
    ->setLanguage('en_US')
    ->setCategory('MARKETING')
    ->addHeader('IMAGE', $imagePath)
    ->addBody('Hi {{1}}, your order {{2}} has been shipped!', ['John', '12345'])
    ->addFooter('Thank you for your purchase!')
    ->save();
```

---

### Crear Plantillas de Marketing con Botones de URL

Puedes agregar botones de URL personalizados para redirigir a los usuarios a p√°ginas espec√≠ficas.

![Ejemplo de plantilla de marketing](assets/template_3.png "Plantilla de Marketing")

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

// Obtener la cuenta empresarial
$account = WhatsappBusinessAccount::first();

// Ruta de la imagen
$imagePath = storage_path('app/public/laravel-whatsapp-manager.png');

// Crear una plantilla de marketing con imagen y botones de URL
$template = Whatsapp::template()
    ->createMarketingTemplate($account)
    ->setName('image_template_test_2')
    ->setLanguage('en_US')
    ->setCategory('MARKETING')
    ->addHeader('IMAGE', $imagePath)
    ->addBody('Hi {{1}}, your order {{2}} has been shipped!', ['John', '12345'])
    ->addFooter('Thank you for your purchase!')
    ->addButton('PHONE_NUMBER', 'Call Us', '+573234255686')
    ->addButton('URL', 'Track Order', 'https://example.com/track?order={{1}}', ['12345'])
    ->save();
```

---

### Crear Variaciones de Plantillas de Marketing

Puedes crear m√∫ltiples variaciones de plantillas para diferentes prop√≥sitos.

![Ejemplo de plantilla de marketing](assets/template_4.png "Plantilla de Marketing")

```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;

// Obtener la cuenta empresarial
$account = WhatsappBusinessAccount::first();

// Crear una variaci√≥n de plantilla de marketing
$template = Whatsapp::template()
    ->createMarketingTemplate($account)
    ->setName('personal_promotion_text_only_22')
    ->setLanguage('en')
    ->addHeader('TEXT', 'Our {{1}} is on!', ['Summer Sale'])
    ->addBody(
        'Shop now through {{1}} and use code {{2}} to get {{3}} off of all merchandise.',
        ['the end of August', '25OFF', '25%']
    )
    ->addFooter('Use the buttons below to manage your marketing subscriptions')
    ->addButton('QUICK_REPLY', 'Unsubscribe from Promos')
    ->addButton('QUICK_REPLY', 'Unsubscribe from All')
    ->save();
```


## 13. Enviar Mensajes a partir de Plantilla creada.
### Enviar mensajes de plantillas

Puedes enviar diferentes mensajes de plantillas segun la estructura de la plantilla.


```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;
use ScriptDevelop\WhatsappManager\Models\WhatsappPhoneNumber;

// Obtener la cuenta empresarial
$account = WhatsappBusinessAccount::first();
$phone = WhatsappPhoneNumber::first();

// Enviar plantilla 1
$message = Whatsapp::template()
    ->sendTemplateMessage($phone)
    ->to('57', '3137555908')
    ->usingTemplate('order_confirmation_4')
    ->addBody(['12345'])
    ->send();

// Enviar plantilla 2
$message = Whatsapp::template()
    ->sendTemplateMessage($phone)
    ->to('57', '3135666627')
    ->usingTemplate('link_de_pago')
    ->addHeader('TEXT', '123456')
    ->addBody(['20000'])
    ->addButton('URL', 'Pagar', 'https://mpago.li/1QFwRV', ['1QFwRV'])
    ->send();

```
## 14. Bot Builder, Contructor de Bot y mensajes automatizados.
### Crear BOTS de Whatsapp

Puedes diferentes tipos de Bots para whatsapp.


```php
use ScriptDevelop\WhatsappManager\Facades\Whatsapp;
use ScriptDevelop\WhatsappManager\Models\WhatsappBusinessAccount;
use ScriptDevelop\WhatsappManager\Models\WhatsappPhoneNumber;

// Obtener la cuenta empresarial
$account = WhatsappBusinessAccount::first();
$phone = WhatsappPhoneNumber::first();

// Crear Bot de whatsapp
$bot = Whatsapp::bot()
    ->createBot(
        [
            'name' => 'Soporte T√©cnico',
            'phone_number_id' => $phone->phone_number_id,
            'trigger_keywords' => ['soporte', 'ayuda'],
        ]);

// Ver detalle de un Bot de whatsapp
$botDetail = Whatsapp::bot()->getById($bot->whatsapp_bot_id);

```

### Bot con flujo de conversacion y pasos de pruebas

```php
// 1. Seleccionar cuenta y numero para el bot
// Cuenta de whatsapp
$account = WhatsappBusinessAccount::find(214545545097167);

// Numerod e whatsapp
$phone = $account->phoneNumbers->first();

// 2. Crear bot
$bot = Whatsapp::bot()->createBot([
    'name' => 'Bot Bienvenida',
    'phone_number_id' => $phone->phone_number_id,
    'description' => 'Bot de Bienvenida',
    'on_failure_action' => 'assign_agent',
    'failure_message' => 'Transferiendo a agente...'
]);

// 3. Crear flujo
$flow = Whatsapp::flow()->createFlow([
    'name' => 'Flujo de pruebas',
    'description' => 'Flujo que funciona para realizar pruebas',
    'type' => 'inbound',
    'trigger_mode' => 'any',
    'is_default' => false
]);
$flow->addKeywordTrigger(['Hola', 'Buenos dias'], false, 'contains');
$flow = $flow->build();
$bot->flows()->attach($flow->flow_id);

// 4. Crear servicio de pasos
$stepService = Whatsapp::step($flow);
use ScriptDevelop\WhatsappManager\Enums\StepType;

// Paso 1: Bienvenida
$step1 = $stepService->createStep('Bienvenida', StepType::MESSAGE_SEQUENCE)
    ->addTextMessage("¬°Hola! Este flujo es de pruebas.", 1, 0)
    ->build();

// Paso 2: Pregunta edad
$step2 = $stepService->createStep('Pregunta Edad', StepType::OPEN_QUESTION)
    ->addTextMessage("¬øCu√°ntos a√±os tienes?", 1, 0)
    ->addVariable('edad', 'number', 'global', ['required','numeric','min:1'])
    ->setValidationRules(['edad' => 'required|numeric|min:1'], 2, "Edad inv√°lida")
    ->build();

// Paso 3: Condicional
$step3 = $stepService->createStep('Mayor de edad', StepType::MESSAGE_SEQUENCE)
    ->addTextMessage("Eres mayor de edad", 1, 0)
    ->build();

$step4 = $stepService->createStep('Menor de edad', StepType::MESSAGE_SEQUENCE)
    ->addTextMessage("Eres menor de edad", 1, 0)
    ->build();

// Paso 5: Despedida
$step5 = $stepService->createStep('Despedida', StepType::TERMINAL)
    ->addTextMessage("¬°Gracias por participar!", 1, 0)
    ->build();

// 6. Crear transiciones (compatibles con la prueba)
$step1->transitions()->create([
    'to_step_id' => $step2->step_id,
    'condition_type' => 'always',
    'priority' => 1
]);

$step2->transitions()->create([
    'to_step_id' => $step3->step_id,
    'condition_type' => 'variable_value',
    'condition_config' => ['variable' => 'edad', 'operator' => '>=', 'value' => 18],
    'priority' => 2
]);

$step2->transitions()->create([
    'to_step_id' => $step4->step_id,
    'condition_type' => 'variable_value',
    'condition_config' => ['variable' => 'edad', 'operator' => '<', 'value' => 18],
    'priority' => 1
]);

$step3->transitions()->create([
    'to_step_id' => $step5->step_id,
    'condition_type' => 'always',
    'priority' => 1
]);

$step4->transitions()->create([
    'to_step_id' => $step5->step_id,
    'condition_type' => 'always',
    'priority' => 1
]);

// 7. Establecer paso inicial
$flow->update(['entry_point_id' => $step1->step_id]);
```


1. Whatsapp (Facade)
M√©todos Principales:

account(): Acceso a AccountRegistrationService

message(): Acceso a MessageDispatcherService

phone(): Acceso a WhatsappService

template(): Acceso a TemplateService

bot(): Accesoa BotBuilderService

getBusinessAccount(): Obtiene datos de una cuenta empresarial

getPhoneNumbers(): Lista n√∫meros asociados a una cuenta

getPhoneNumberDetails(): Detalles t√©cnicos de un n√∫mero

getBusinessProfile(): Perfil comercial vinculado a un n√∫mero

2. WhatsappService
M√©todos Clave:

forAccount(): Establece la cuenta activa para operaciones

getBusinessAccount(): Datos de cuenta (nombre, timezone, IDs)

getPhoneNumbers(): Listado de n√∫meros telef√≥nicos

getPhoneNumberDetails(): Verificaci√≥n, rating de calidad, configuraci√≥n

getBusinessProfile(): Descripci√≥n, email, logo, direcci√≥n

withTempToken(): Autenticaci√≥n temporal para operaciones

3. TemplateService
Gesti√≥n de Plantillas:

getTemplates(): Sincroniza plantillas desde la API

getTemplateById()/getTemplateByName(): B√∫squeda espec√≠fica

createUtilityTemplate()/createMarketingTemplate()/createAuthenticationTemplate(): Builders para tipos de plantillas

deleteTemplateById()/deleteTemplateByName(): Eliminaci√≥n (soft/hard delete)

sendTemplateMessage(): Constructor para enviar plantillas

createUploadSession()/uploadMedia(): Manejo de archivos multimedia

TemplateBuilder (Subservicio):

setName()/setLanguage()/setCategory(): Configuraci√≥n b√°sica

addHeader(): Texto, im√°genes o ubicaci√≥n

addBody(): Texto con par√°metros din√°micos

addFooter(): Texto est√°tico

addButton(): URL, tel√©fono o quick reply

save(): Crea/actualiza plantillas en la API y DB

4. AccountRegistrationService
M√©todos Clave:

register(): Flujo completo de registro (cuenta + n√∫meros + perfiles)

validateInput(): Verifica token y business ID

fetchAccountData(): Obtiene metadata de la API

upsertBusinessAccount(): Crea/actualiza cuenta en DB

registerPhoneNumbers(): Sincroniza n√∫meros telef√≥nicos

linkBusinessProfilesToPhones(): Vincula perfiles comerciales

5. MessageDispatcherService
Env√≠o de Mensajes:

sendTextMessage(): Mensaje b√°sico con vista previa opcional

sendReplyTextMessage(): Respuesta a mensaje existente

sendImageMessage()/sendAudioMessage()/sendVideoMessage(): Multimedia desde archivo

sendDocumentMessage(): PDF, Excel, Word con caption

sendStickerMessage(): Stickers est√°ticos/animados

sendContactMessage(): Comparte tarjeta de contacto

sendLocationMessage(): Coordenadas + direcci√≥n

M√©todos de Soporte:

uploadFile(): Sube archivos a la API

downloadMedia(): Descarga medios a almacenamiento local

validateMediaFile(): Verifica formatos y tama√±os

resolveContact(): Crea/recupera contactos en DB

Manejo de Respuestas:

Todos los m√©todos tienen versi√≥n sendReply...Message() para respuestas contextuales.

6. TemplateMessageBuilder
Construcci√≥n Din√°mica:

to(): Define destinatario (pa√≠s + n√∫mero)

usingTemplate(): Selecciona plantilla por ID/nombre

addHeader()/addBody()/addFooter(): Componentes est√°ticos

addButton(): Hasta 10 botones por mensaje

send(): Valida y env√≠a el mensaje estructurado

Flujos T√©cnicos Destacados
Registro de Cuenta:
register() -> validateInput() -> fetchAccountData() -> upsertBusinessAccount() -> registerPhoneNumbers()

Env√≠o de Multimedia:
validateMediaFile() -> createUploadSession() -> uploadMedia() -> send...Message()

Plantillas con Par√°metros:
TemplateBuilder -> addHeader()/addBody() -> storeOrUpdateTemplate() -> syncTemplateComponents()


---

### Notas

- Aseg√∫rate de que las im√°genes utilizadas en las plantillas cumplan con los requisitos de la API de WhatsApp (tama√±o y formato).
- Los botones de URL pueden incluir par√°metros din√°micos utilizando las variables de las plantillas (`{{1}}`, `{{2}}`, etc.).
- Revisa los logs para depurar cualquier problema durante la creaci√≥n de plantillas.



ü§ù Contribuir
¬°Tu ayuda es bienvenida! Sigue estos pasos:

Haz un fork del repositorio

Crea una rama: git checkout -b feature/nueva-funcionalidad

Haz commit: git commit -m 'Add some feature'

Push: git push origin feature/nueva-funcionalidad

Abre un Pull Request

üìÑ Licencia
MIT License. Ver LICENSE para m√°s detalles.

üë®üíª Soporte
¬øProblemas o sugerencias?
üìß Contacto: soporte@scriptdevelop.com
üêû Reporta un issue: GitHub Issues

Desarrollado con ‚ù§Ô∏è por ScriptDevelop
‚ú® Potenciando tu conexi√≥n con WhatsApp Business API


---

### üî• Caracter√≠sticas Destacadas del README
1. **Jerarqu√≠a Visual Clara**: Uso de emojis y encabezados para guiar la lectura.
2. **Sintaxis Resaltada**: Bloques de c√≥digo con syntax highlighting.
3. **Badges Interactivos** (A√±ade estos al inicio):

   [![Latest Version](https://img.shields.io/packagist/v/scriptdevelop/whatsapp-manager.svg?style=flat-square)](https://packagist.org/packages/scriptdevelop/whatsapp-manager)
   [![PHP Version](https://img.shields.io/badge/PHP-8.1%2B-8892BF.svg?style=flat-square)](https://php.net/)
   [![Laravel Version](https://img.shields.io/badge/Laravel-10%2B-FF2D20.svg?style=flat-square)](https://laravel.com)

4.  Secciones Colapsables (Usa detalles HTML si necesitas):
    <details>
    <summary>üì¶ Ver estructura completa del paquete</summary>
    <!-- Contenido -->
    </details>
